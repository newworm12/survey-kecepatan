<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Kecepatan</title>

<style>
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:100%;
  max-width:360px;
  background:#1e1e1e;
  border-radius:16px;
  padding:20px;
}
input,button{
  width:100%;
  height:44px;
  margin-bottom:10px;
  border-radius:10px;
  border:none;
  padding:0 10px;
}
button{
  font-weight:600;
  cursor:pointer;
}
.start{background:#4caf50;color:#000}
.stop{background:#f44336;color:#fff}
.locked{opacity:.35;pointer-events:none}
#sessionCode{
  background:#4caf50;
  color:#000;
  text-align:center;
  padding:8px;
  border-radius:8px;
  font-weight:bold;
}
</style>
</head>

<body>
<div class="card">

<h3>Survey Kecepatan</h3>

<input id="distance" type="number" value="50" placeholder="Jarak (meter)">

<button onclick="createSession()">BUAT SESSION</button>
<div id="sessionCode"></div>

<input id="joinInput" placeholder="Masukkan Session ID">
<button onclick="joinSession()">GABUNG SESSION</button>

<div id="stopwatch" class="locked">
  <h1 id="time">0.000</h1>
  <div id="speed">0 km/jam</div>
  <button class="start" onclick="start()">START</button>
  <button class="stop" onclick="stop()">STOP</button>
</div>

<div id="status">Status: -</div>

</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBbsJPQtHknhrmE9naA31l9uBC2Sb4XYL8",
  databaseURL: "https://stopwatch-survey-default-rtdb.asia-southeast1.firebasedatabase.app"
});

let sessionId = null;
let timer = null;

const db = firebase.database();
const stopwatch = document.getElementById("stopwatch");
const timeEl = document.getElementById("time");
const speedEl = document.getElementById("speed");
const statusEl = document.getElementById("status");

/* ===== CREATE SESSION ===== */
function createSession(){
  sessionId = Math.random().toString(36).substr(2,6);
  db.ref("sessions/"+sessionId).set({
    distance: Number(distance.value),
    status: "IDLE",
    start_time: 0,
    stop_time: 0
  });
  document.getElementById("sessionCode").innerText =
    "SESSION ID: "+sessionId;
  listen();
}

/* ===== JOIN SESSION ===== */
function joinSession(){
  sessionId = joinInput.value.trim();
  if(!sessionId) return alert("Masukkan session ID");

  db.ref("sessions/"+sessionId).once("value").then(s=>{
    if(!s.exists()) return alert("Session tidak ada");
    listen();
  });
}

/* ===== START ===== */
function start(){
  if(!sessionId) return;
  db.ref("sessions/"+sessionId).update({
    status:"RUNNING",
    start_time: firebase.database.ServerValue.TIMESTAMP
  });
}

/* ===== STOP ===== */
function stop(){
  if(!sessionId) return;
  db.ref("sessions/"+sessionId).update({
    status:"STOPPED",
    stop_time: firebase.database.ServerValue.TIMESTAMP
  });
}

/* ===== REALTIME ===== */
function listen(){
  stopwatch.classList.remove("locked");

  db.ref("sessions/"+sessionId).on("value",s=>{
    const d = s.val();
    if(!d) return;

    statusEl.innerText = "Status: "+d.status;

    if(d.status==="RUNNING"){
      clearInterval(timer);
      timer = setInterval(()=>{
        timeEl.innerText =
          ((Date.now()-d.start_time)/1000).toFixed(3);
      },50);
    }

    if(d.status==="STOPPED"){
      clearInterval(timer);
      const dur = d.stop_time - d.start_time;
      timeEl.innerText = (dur/1000).toFixed(3);
      speedEl.innerText =
        ((d.distance/1000)/(dur/3600000)).toFixed(2)+" km/jam";
    }
  });
}
</script>
</body>
</html>
