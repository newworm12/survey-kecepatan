<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Kecepatan</title>


<style>
*,
*::before,
*::after {
  box-sizing: border-box;
}


body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#111;
  color:#fff;
}
.wrapper{
  max-width:380px;
  margin:auto;
  padding:16px;
  overflow-x:hidden;
}
.control{
  background:#7a1c1c;
  padding:12px;
  border-radius:14px;
  margin-bottom:16px;
  transition: background 0.4s ease;
}


.control.active{
  background:#2e7d32;
}
select,input,button{
  width:100%;
  height:42px;
  margin-bottom:8px;
  border-radius:10px;
  border:none;
  padding:0 10px;
}
button{font-weight:600;cursor:pointer}
.big{
  background:#1e1e1e;
  border-radius:18px;
  padding:24px 16px;
  text-align:center;
}
.time{
  font-size:48px;
  font-weight:bold;
}
.speed{
  color:#ff9800;
  margin-bottom:20px;
}
.start{background:#4caf50;color:#000}
.stop{background:#f44336;color:#fff}
.locked{
  opacity:.35;
  pointer-events:none;
}
  
.control.active{
  background:#2e7d32;
}
  
.distance-field{
  position: relative;
  margin-bottom: 8px;
}

.distance-field input{
  width:100%;
  height:42px;
  padding-right:42px; /* ruang untuk "m" */
  border-radius:10px;
  border:none;
}

.distance-field .unit{
  position:absolute;
  right:12px;
  top:50%;
  transform:translateY(-50%);
  color:#aaa;
  font-size:14px;
  pointer-events:none;
}
.surveyor-field{
  margin-bottom:12px;
}
.surveyor-field input{
  width:100%;
  height:42px;
  border-radius:10px;
  border:none;
  padding:0 12px;
  font-weight:600;
}
.app-credit{
  position: fixed;
  right: 12px;
  bottom: 10px;
  font-size: 11px;
  color: #4caf50;
  opacity: 0.5;
  user-select: none;
  pointer-events: none;
}


</style>
</head>

<body>
<div class="wrapper">

  <!-- Nama Surveyor -->
  <div class="surveyor-field">
    <input id="surveyor" type="text" placeholder="Nama Surveyor">
  </div>

  <!-- CONTROL BAR -->
  <div id="controlBar" class="control">

    <!-- Jarak -->
    <div class="distance-field">
      <input id="distance" type="number" value="50">
      <span class="unit">Meter</span>
    </div>

    <!-- Role -->
    <select id="role">
      <option value="A">Petugas A (START)</option>
      <option value="B">Petugas B (STOP)</option>
    </select>
<!-- Jenis Kendaraan -->
<select id="vehicleType">
  <option value="">Pilih Jenis Kendaraan</option>
  <option value="SM">SM â€“ Sepeda Motor</option>
  <option value="MP">MP â€“ Mobil Penumpang</option>
  <option value="KB">KB â€“ Kendaraan Berat</option>
  <option value="KTB">KTB â€“ Kendaraan Tak Bermotor</option>
</select>

    <!-- A -->
    <div id="areaA">
      <button onclick="createSession()">BUAT SESSION</button>
      <div id="sessionCode"></div>
    </div>

    <!-- B -->
    <div id="areaB" style="display:none">
      <input id="joinInput" placeholder="Masukkan Session ID">
      <button onclick="joinSession()">GABUNG SESSION</button>
    </div>

  </div>


<!-- ===== STOPWATCH ===== -->
<div id="stopwatch" class="big locked">
  <div class="time" id="time">0.000</div>
  <div class="speed" id="speed">0 km/jam</div>

  <button id="btnStart" class="start" onclick="start()">START</button>
  <button id="btnStop" class="stop" onclick="stop()">STOP</button>
  <button
  id="btnCancel"
  style="background:#9e9e9e;color:#000"
  onclick="cancelLast()"
>
  CANCEL DATA TERAKHIR
</button>


  <div id="status">Status: -</div>
 <div id="vehicleInfo" style="margin-top:6px;color:#aaa"></div>


 
</div>


<button onclick="resetSession()" style="background:#ff9800;color:#000">
  RESET
</button>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbw9cbqL4_UJR1Ox7c0k9TO8pIonsrtH6k-wJ5hpmdW1ml1FH-MLoeaC3w2MfNjoCFcW/exec";

firebase.initializeApp({
  apiKey: "AIzaSyBbsJPQtHknhrmE9naA31l9uBC2Sb4XYL8",
  databaseURL: "https://stopwatch-survey-default-rtdb.asia-southeast1.firebasedatabase.app"
});
let sessionId = null;
let localStartTime = 0;
let timer = null;
let timerRunning = false;
const db = firebase.database();
let lastRecordId = null;
const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const vehicleSelect = document.getElementById("vehicleType");
const vehicleInfo = document.getElementById("vehicleInfo");
const role=document.getElementById("role");
const areaA=document.getElementById("areaA");
const areaB=document.getElementById("areaB");
const controlBar=document.getElementById("controlBar");
const stopwatch=document.getElementById("stopwatch");
const timeEl=document.getElementById("time");
const speedEl=document.getElementById("speed");
const statusEl=document.getElementById("status");
const surveyorInput = document.getElementById("surveyor");
let sessionListener = null;

// ===== KONTROL AKTIF/TIDAK TOMBOL START =====
function updateStartState() {
  btnStart.disabled =
    role.value !== "A" ||
    !surveyorInput.value.trim() ||
    !vehicleSelect.value;
}
surveyorInput.addEventListener("input", updateStartState);
vehicleSelect.addEventListener("change", updateStartState);
role.addEventListener("change", updateStartState);
updateStartState();

// ===== SINKRON GANTI KENDARAAN (PETUGAS A) =====
vehicleSelect.addEventListener("change", () => {
  if (role.value !== "A") return;
  if (!sessionId) return;

  db.ref("sessions/" + sessionId).once("value").then(s => {
    const d = s.val();
    if (!d) return;

    // hanya boleh ganti kendaraan saat IDLE
    if (d.status !== "IDLE") return;

    db.ref("sessions/" + sessionId).update({
      vehicle: vehicleSelect.value
    });
  });
});
  
// load otomatis
surveyorInput.value = localStorage.getItem("surveyor") || "";

// simpan setiap ketik
surveyorInput.addEventListener("input", () => {
  localStorage.setItem("surveyor", surveyorInput.value.trim());
});

role.onchange = () => {
  areaA.style.display = role.value === "A" ? "block" : "none";
  areaB.style.display = role.value === "B" ? "block" : "none";

  // ðŸ”’ kunci kendaraan untuk Petugas B
  vehicleSelect.disabled = role.value === "B";
};
role.onchange();


/* ===== CREATE ===== */
function createSession(){
  const dist = Number(distance.value);

  if (isNaN(dist) || dist <= 0) {
    alert("Jarak tidak valid");
    return;
  }

  sessionId = Math.random().toString(36).substr(2,6);

  if (!vehicleSelect.value) {
  alert("Pilih jenis kendaraan");
  return;
}

db.ref("sessions/" + sessionId).set({
  distance: dist,
  vehicle: vehicleSelect.value,
  status: "IDLE",
  start_time: 0,
  stop_time: 0
});


  document.getElementById("sessionCode").innerText =
    "SESSION ID: " + sessionId;

  activate();
}


/* ===== JOIN ===== */
function joinSession(){
  const id=joinInput.value.trim();
  if(!id) return alert("Masukkan session ID");
  
  db.ref("sessions/"+id).once("value").then(s=>{
    if(!s.exists()) return alert("Session tidak ada");
    sessionId=id;
    activate();
  });
}

/* ===== ACTIVATE ===== */
function activate(){
  controlBar.classList.add("active");
  stopwatch.classList.remove("locked");

  if (sessionListener) {
    db.ref("sessions/" + sessionId).off("value", sessionListener);
  }

  sessionListener = s => {
    const d = s.val();
    if (!d) return;

   statusEl.innerText = "Status: " + d.status;

    if (d.vehicle) {
  vehicleInfo.innerText = "Kendaraan: " + d.vehicle;
} else {
  vehicleInfo.innerText = "Menunggu kendaraan dari Petugas A";
}

    // kunci kendaraan saat RUNNING
if (role.value === "B") {
  vehicleSelect.disabled = true;
} else {
  vehicleSelect.disabled = d.status === "RUNNING";
}


    // ===== TIMER STATE =====
    if (d.status === "IDLE") {
      clearInterval(timer);
      timer = null;
      timerRunning = false;
      localStartTime = 0;

      timeEl.innerText = "0.000";
      speedEl.innerText = "0 km/jam";
      btnStart.disabled = role.value !== "A";
      btnStop.disabled = true;

  // ðŸ”¥ AKTIFKAN ULANG LISTENER UNTUK SESSION YANG SAMA

    }

    else if (d.status === "RUNNING") {
      btnStart.disabled = true;
      btnStop.disabled = role.value !== "B";

      if (role.value === "A") return;

      if (!timerRunning && d.start_time > 0) {
        timerRunning = true;
        localStartTime = d.start_time;

        clearInterval(timer);
        timer = setInterval(() => {
          const diff = Date.now() - localStartTime;
          timeEl.innerText = Math.max(0, diff / 1000).toFixed(3);
        }, 50);
      }
    }

    else if (d.status === "STOPPED") {
      clearInterval(timer);
      timer = null;
      timerRunning = false;
      localStartTime = 0;

      const dur = d.stop_time - d.start_time;
      timeEl.innerText = (dur / 1000).toFixed(3);
      speedEl.innerText =
        ((d.distance / 1000) / (dur / 3600000)).toFixed(2) + " km/jam";

      btnStart.disabled = true;
      btnStop.disabled = true;
    }
  };

  db.ref("sessions/" + sessionId).on("value", sessionListener);
}













/* ===== START ===== */
function start(){
  if (role.value !== "A") return;

  const nama = surveyorInput.value.trim();
  const kendaraan = vehicleSelect.value;

  if (!nama) {
    alert("Nama surveyor harus diisi");
    return;
  }
  if (!kendaraan) {
    alert("Pilih jenis kendaraan");
    return;
  }

  const startTime = Date.now();

  // timer lokal A
  localStartTime = startTime;
  timerRunning = true;

  clearInterval(timer);
  timer = setInterval(() => {
    const diff = Date.now() - localStartTime;
    timeEl.innerText = (diff / 1000).toFixed(3);
  }, 16);

  // ðŸ”¥ STATUS HARUS RUNNING
  db.ref("sessions/" + sessionId).update({
    status: "RUNNING",
    start_time: startTime,
    surveyor: nama,
    vehicle: kendaraan
  });
}











/* ===== STOP ===== */
function stop(){
  if(role.value !== "B") return alert("STOP hanya Petugas B");

  const stopTime = Date.now();

  const recordId = sessionId + "-" + stopTime;
  lastRecordId = recordId;

  db.ref("sessions/"+sessionId).once("value").then(s => {
    const d = s.val();
    if (!d || !d.start_time) return;

    const durMs = stopTime - d.start_time;
    const durSec = (durMs / 1000).toFixed(3);
    const speed = ((d.distance / 1000) / (durMs / 3600000)).toFixed(2);

    const now = new Date();

    const payload = {
  tanggal: now.toLocaleDateString("id-ID"),
  jam: now.toLocaleTimeString("id-ID"),
  sessionId: sessionId,
  surveyor: d.surveyor || "",
  vehicle: d.vehicle,
  distance: d.distance,
  duration: durSec,
  speed: speed,
  recordId: recordId   // âœ… INI SEKARANG VALID
};



  

const params = new URLSearchParams(payload);
navigator.sendBeacon(
  SHEET_API_URL,
  new URLSearchParams(payload)
);



    // update Firebase status
    db.ref("sessions/"+sessionId).update({
      status: "STOPPED",
      stop_time: stopTime
    });
  });
}



  /* ===== RESET ===== */
 function resetSession(){
  if (role.value !== "A")
    return alert("RESET hanya boleh oleh Petugas A");

  if (!sessionId) return;

  const ok = confirm("Reset stopwatch?");
  if (!ok) return;

  // ðŸ”¹ UPDATE FIREBASE (DATA SAJA)
  db.ref("sessions/" + sessionId).update({
    status: "IDLE",
    start_time: 0,
    stop_time: 0,
    vehicle: ""
  });

  // ðŸ”¹ LEPAS LISTENER (DI LUAR update)
  if (sessionListener) {
    db.ref("sessions/" + sessionId).off("value", sessionListener);
    sessionListener = null;
  }

  // ðŸ”¹ RESET UI
  clearInterval(timer);
  timer = null;
  timerRunning = false;
  localStartTime = 0;

  timeEl.innerText = "0.000";
  speedEl.innerText = "0 km/jam";
  statusEl.innerText = "Status: IDLE";
  vehicleInfo.innerText = "";

  if (role.value === "A") {
    vehicleSelect.disabled = false;
    vehicleSelect.value = "";
  }

  btnStart.disabled = role.value !== "A";
  btnStop.disabled = true;
}

function cancelLast() {
  if (!lastRecordId) {
    alert("Tidak ada data yang bisa dibatalkan");
    return;
  }

  const ok = confirm("Batalkan data terakhir?");
  if (!ok) return;

  const payload = {
    action: "cancel",
    recordId: lastRecordId
  };

  navigator.sendBeacon(
    SHEET_API_URL,
    new URLSearchParams(payload)
  );

  alert("Data terakhir dibatalkan");

  lastRecordId = null;
}


</script>
<div class="app-credit">
  WEB created by N4yr4
</div>

  
</body>
</html>
