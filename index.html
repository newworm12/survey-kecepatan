<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Kecepatan</title>


<style>
  .stopwatch.locked{
  opacity: 0.35;
  pointer-events: none;
}
.control-ok{
  background:#4caf50 !important;
  color:#000 !important;
}
#controlBar{
  position: relative;
  z-index: 2;
}

#stopwatch{
  position: relative;
  z-index: 1;
  margin-top: 12px;
}

.stopwatch.locked{
  opacity: 0.35;
  pointer-events: none;
}

  body{
    margin:0;
    font-family:system-ui, sans-serif;
    background:#111;
    color:#fff;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }

  .card{
    width:100%;
    max-width:360px;
    background:#1e1e1e;
    border-radius:16px;
    padding:20px;
    box-shadow:0 10px 30px rgba(0,0,0,.6);
  }

  h2{
    margin:0 0 10px;
    text-align:center;
  }

  .time{
    font-size:42px;
    text-align:center;
    margin:20px 0;
    font-weight:bold;
  }

  .speed{
    text-align:center;
    margin-bottom:16px;
    color:#ff9800;
  }

  button{
    width:100%;
    height:48px;
    margin-top:10px;
    border:none;
    border-radius:12px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
  }

  .start{ background:#4caf50; color:#000; }
  .stop{ background:#f44336; color:#fff; }

  select, input{
    width:100%;
    height:44px;
    border-radius:10px;
    border:none;
    margin-bottom:10px;
    padding:0 10px;
    font-size:14px;
  }

  .status{
    text-align:center;
    margin-top:10px;
    font-size:13px;
    color:#aaa;
  }
</style>
</head>

<body>

<div class="card">

  <!-- ===== CONTROL BAR ===== -->
  <div id="controlBar">
    <select id="role">
      <option value="A">Peran A (START)</option>
      <option value="B">Peran B (STOP)</option>
    </select>

    <input id="petugas" placeholder="Nama Petugas">

    <!-- AREA A -->
    <div id="areaA" style="display:none">
      <button onclick="generateCode()">Generate Kode (A)</button>
      <div id="kodeA"></div>
    </div>

    <!-- AREA B -->
    <div id="areaB" style="display:none">
      <input id="pairInput" placeholder="Masukkan Kode (B)">
      <button id="pairBtn" onclick="pairAsB()">PAIR (B)</button>
    </div>

    <input id="distance" type="number" value="50" placeholder="Jarak (meter)">
  </div>

  <!-- ===== STOPWATCH ===== -->
  <div id="stopwatch" class="stopwatch locked">
    <div id="time">0.000</div>
    <div id="speed">0 km/jam</div>
    <button onclick="start()">START</button>
    <button onclick="stop()">STOP</button>
  </div>

  <div id="status">Status: IDLE</div>
</div>


  
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ========= FIREBASE ========= */
firebase.initializeApp({
  apiKey: "AIzaSyBbsJPQtHknhrmE9naA31l9uBC2Sb4XYL8",
  authDomain: "stopwatch-survey.firebaseapp.com",
  databaseURL: "https://stopwatch-survey-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "stopwatch-survey"
});
const ref = firebase.database().ref("survey_speed");

/* ========= DOM ========= */
const role = document.getElementById("role");
const petugas = document.getElementById("petugas");
const distance = document.getElementById("distance");
const pairInput = document.getElementById("pairInput");

const areaA = document.getElementById("areaA");
const areaB = document.getElementById("areaB");
const kodeA = document.getElementById("kodeA");

const stopwatch = document.getElementById("stopwatch");
const statusEl = document.getElementById("status");
const timeEl = document.getElementById("time");
const speedEl = document.getElementById("speed");

let timer = null;

/* ========= ROLE UI ========= */
role.onchange = () => {
  areaA.style.display = role.value === "A" ? "block" : "none";
  areaB.style.display = role.value === "B" ? "block" : "none";
};
role.onchange(); // ← WAJIB

/* ========= ACTION ========= */
window.generateCode = () => {
  if (!petugas.value.trim()) return alert("Isi nama A");

  const code = Math.random().toString(36).substring(2,6).toUpperCase();
  ref.set({
    pairing_code: code,
    pairing_status: "OPEN",
    pair_A: petugas.value.trim(),
    pair_B: "",
    distance_m: Number(distance.value),
    status: "IDLE"
  });

  kodeA.innerText = "KODE: " + code;
  kodeA.classList.add("control-ok");
};

window.pairAsB = () => {
  if (!pairInput.value.trim())
  return alert("Masukkan kode pairing");

  if (!petugas.value.trim()) return alert("Isi nama B");

  ref.once("value").then(s => {
    const d = s.val();
    if (!d) return alert("Data tidak ada");

    if (d.pairing_status !== "OPEN")
      return alert("Pairing sudah terkunci");

    if (pairInput.value !== d.pairing_code)
      return alert("Kode salah");

    ref.update({
      pair_B: petugas.value.trim(),
      pairing_status: "LOCKED"
    }).then(() => {
      const btn = document.getElementById("pairBtn");
      btn.classList.add("control-ok");
      btn.innerText = "PAIRED";
      btn.disabled = true;
    });
  });
};

window.start = () => {
  if (role.value !== "A")
    return alert("START hanya untuk A");

  ref.once("value").then(s => {
    const d = s.val();
    if (d.pairing_status !== "LOCKED")
      return alert("Belum pairing");

    if (d.status === "RUNNING")
      return;

    ref.update({
      status: "RUNNING",
      start_time: firebase.database.ServerValue.TIMESTAMP
    });
  });
};

window.stop = () => {
  if (role.value !== "B")
    return alert("STOP hanya untuk B");

  ref.once("value").then(s=>{
    const d = s.val();
    if (d.status !== "RUNNING") return;

    ref.update({
      status: "STOPPED",
      stop_time: firebase.database.ServerValue.TIMESTAMP
    });
  });
};

/* ========= REALTIME ========= */
ref.on("value", s => {
  const d = s.val();
  if (!d) return;

  statusEl.innerText = "Status: " + d.status;

  // ❌ Tolak device asing
  if (
    role.value === "A" &&
    d.pair_A &&
    d.pair_A !== petugas.value.trim()
  ) {
    alert("Device ini bukan A yang sah");
    location.reload();
    return;
  }

  if (
    role.value === "B" &&
    d.pair_B &&
    d.pair_B !== petugas.value.trim()
  ) {
    alert("Device ini bukan B yang sah");
    location.reload();
    return;
  }

  /* ===== PAIRING SELESAI ===== */
 /* ===== PAIRING SELESAI ===== */
if (d.pairing_status === "LOCKED") {
  // buka stopwatch
  stopwatch.classList.remove("locked");

  // ===== ROLE B =====
  if (role.value === "B") {
    const btn = document.getElementById("pairBtn");
    btn.disabled = true;
    btn.classList.add("control-ok");
    btn.innerText = "PAIRED";
  }

  // ===== ROLE A =====
  if (role.value === "A") {
    const genBtn = areaA.querySelector("button");
    if (genBtn) genBtn.disabled = true;
  }
}

  /* ===== STOPWATCH RUNNING ===== */
  if (d.status === "RUNNING") {
    clearInterval(timer);
    timer = setInterval(() => {
      timeEl.innerText =
        ((Date.now() - d.start_time) / 1000).toFixed(3);
    }, 50);
  }

  /* ===== STOPPED ===== */
  if (d.status === "STOPPED") {
    clearInterval(timer);
    const dur = d.stop_time - d.start_time;
    timeEl.innerText = (dur / 1000).toFixed(3);

    speedEl.innerText =
      ((d.distance_m / 1000) / (dur / 3600000)).toFixed(2) + " km/jam";
  }

  /* ===== RESET ===== */
  if (d.status === "IDLE") {
    clearInterval(timer);
    timeEl.innerText = "0.000";
    speedEl.innerText = "0 km/jam";
  }
});


</script>

<!-- Firebase -->


</body>
</html>
