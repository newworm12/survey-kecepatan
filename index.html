<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Kecepatan</title>


<style>
  body{
    margin:0;
    font-family:system-ui, sans-serif;
    background:#111;
    color:#fff;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }

  .card{
    width:100%;
    max-width:360px;
    background:#1e1e1e;
    border-radius:16px;
    padding:20px;
    box-shadow:0 10px 30px rgba(0,0,0,.6);
  }

  h2{
    margin:0 0 10px;
    text-align:center;
  }

  .time{
    font-size:42px;
    text-align:center;
    margin:20px 0;
    font-weight:bold;
  }

  .speed{
    text-align:center;
    margin-bottom:16px;
    color:#ff9800;
  }

  button{
    width:100%;
    height:48px;
    margin-top:10px;
    border:none;
    border-radius:12px;
    font-size:16px;
    font-weight:600;
    cursor:pointer;
  }

  .start{ background:#4caf50; color:#000; }
  .stop{ background:#f44336; color:#fff; }

  select, input{
    width:100%;
    height:44px;
    border-radius:10px;
    border:none;
    margin-bottom:10px;
    padding:0 10px;
    font-size:14px;
  }

  .status{
    text-align:center;
    margin-top:10px;
    font-size:13px;
    color:#aaa;
  }
</style>
</head>

<body>

<div class="card">
  <h2>Survey Kecepatan</h2>

  <select id="role">
    <option value="A">Peran A (START)</option>
    <option value="B">Peran B (STOP)</option>
  </select>
<input id="name" placeholder="Nama Petugas">

<!-- AREA A -->
<div id="areaA" style="display:none">
  <button onclick="generateCode()">Generate Kode (A)</button>
  <div class="status" id="kodeA" style="font-size:20px; font-weight:bold; margin-top:8px;"></div>
</div>

<!-- AREA B -->
<div id="areaB" style="display:none">
  <input id="pairInput" placeholder="Masukkan Kode (B)">
</div>

  <input id="distance" type="number" value="50" placeholder="Jarak (meter)">

  <div class="time" id="time">0.000</div>
  <div class="speed" id="speed">0 km/jam</div>

  <button class="start" onclick="start()">START</button>
  <button class="stop" onclick="stop()">STOP</button>

  <div class="status" id="status">Status: IDLE</div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyBbsJPQtHknhrmE9naA31l9uBC2Sb4XYL8",
  authDomain: "stopwatch-survey.firebaseapp.com",
  databaseURL: "https://stopwatch-survey-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "stopwatch-survey",
  storageBucket: "stopwatch-survey.appspot.com",
  messagingSenderId: "371372945922",
  appId: "1:371372945922:web:3152188d2c86034e25ad1b"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const ref = db.ref("survey_speed");
/* =================================================== */

let timer = null;

/* ================= BUTTON LOGIC ================= */

function start(){
  if(role.value !== "A") return alert("Hanya Peran A");
  if(!name.value) return alert("Isi nama petugas");

  ref.once("value").then(snap=>{
    const d = snap.val();

    if(!d || !d.pairing_code){
      alert("Generate kode pairing dulu");
      return;
    }

    if(d.status === "RUNNING"){
      alert("Stopwatch sudah berjalan");
      return;
    }

    ref.update({
      status: "RUNNING",
      start_time: firebase.database.ServerValue.TIMESTAMP,
      stop_time: 0
    });
  });
}



function stop(){
  if(role.value !== "B") return alert("Hanya Peran B");
  if(!name.value) return alert("Isi nama petugas");

  ref.once("value").then(snap=>{
    const d = snap.val();
    if(!d) return;

    if(d.status !== "RUNNING"){
      alert("Stopwatch belum berjalan");
      return;
    }

    if(pairInput.value !== d.pairing_code){
      alert("Kode pairing salah");
      return;
    }

    ref.update({
      status: "STOPPED",
      stop_time: firebase.database.ServerValue.TIMESTAMP,
      petugas_B: name.value
    });
  });
}


/* ================= REALTIME LISTENER ================= */

ref.on("value", snap=>{
  const d = snap.val();
  if(!d) return;

  document.getElementById("pairCode").innerText =
    "Kode: " + (d.pairing_code || "-");

  status.innerText = "Status: " + d.status;

  if(d.status === "RUNNING"){
    clearInterval(timer);
    timer = setInterval(()=>{
      const now = Date.now();
      const t = (now - d.start_time)/1000;
      time.innerText = t.toFixed(3);
    },50);
  }

  if(d.status === "STOPPED"){
    clearInterval(timer);

    const dur = d.stop_time - d.start_time;
    time.innerText = (dur/1000).toFixed(3);

    const speedVal =
      (d.distance_m/1000) / (dur/3600000);

    speed.innerText = speedVal.toFixed(2) + " km/jam";

    ref.update({ duration_ms: dur });
  }

  if(d.status === "IDLE"){
    clearInterval(timer);
    time.innerText = "0.000";
    speed.innerText = "0 km/jam";
  }
});

</script>
  <script>
const roleSelect = document.getElementById("role");
const areaA = document.getElementById("areaA");
const areaB = document.getElementById("areaB");
const kodeA = document.getElementById("kodeA");

function updateRoleUI(){
  if(roleSelect.value === "A"){
    areaA.style.display = "block";
    areaB.style.display = "none";
  } else {
    areaA.style.display = "none";
    areaB.style.display = "block";
  }
}

roleSelect.addEventListener("change", updateRoleUI);
updateRoleUI();
</script>
<script>
function generateCode(){
  if(role.value !== "A") return;
  if(!name.value) return alert("Isi nama petugas A");

  const code = Math.random().toString(36).substring(2,6).toUpperCase();

  ref.set({
    status: "IDLE",
    pairing_code: code,
    petugas_A: name.value,
    petugas_B: "",
    start_time: 0,
    stop_time: 0,
    duration_ms: 0,
    distance_m: Number(distance.value)
  });

  // UI A berubah
  kodeA.innerText = "KODE: " + code;
  areaA.querySelector("button").style.display = "none";
}


</script>

</body>
</html>
