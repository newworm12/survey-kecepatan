<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Survey Kecepatan</title>

<style>
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:#111;
  color:#fff;
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  width:100%;
  max-width:360px;
  background:#1e1e1e;
  border-radius:16px;
  padding:20px;
}
input,select,button{
  width:100%;
  height:44px;
  margin-bottom:10px;
  border-radius:10px;
  border:none;
  padding:0 10px;
}
button{
  font-weight:600;
  cursor:pointer;
}
.start{background:#4caf50}
.stop{background:#f44336;color:#fff}
.locked{
  opacity:.35;
  pointer-events:none;
}
#kode{
  background:#4caf50;
  color:#000;
  padding:8px;
  text-align:center;
  border-radius:8px;
  font-weight:bold;
}
</style>
</head>

<body>
<div class="card">

<select id="role">
  <option value="A">Peran A (START)</option>
  <option value="B">Peran B (STOP)</option>
</select>

<input id="nama" placeholder="Nama Petugas">

<div id="areaA">
  <button onclick="generateCode()">Generate Kode</button>
  <div id="kode"></div>
</div>

<div id="areaB" style="display:none">
  <input id="kodeInput" placeholder="Masukkan Kode">
  <button onclick="pairB()">PAIR</button>
</div>

<input id="distance" type="number" value="50">

<div id="stopwatch" class="locked">
  <h1 id="time">0.000</h1>
  <div id="speed">0 km/jam</div>
  <button class="start" onclick="start()">START</button>
  <button class="stop" onclick="stop()">STOP</button>
</div>

<div id="status">Status: IDLE</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBbsJPQtHknhrmE9naA31l9uBC2Sb4XYL8",
  databaseURL: "https://stopwatch-survey-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const ref = firebase.database().ref("survey_speed");

const role = document.getElementById("role");
const nama = document.getElementById("nama");
const kodeDiv = document.getElementById("kode");
const kodeInput = document.getElementById("kodeInput");
const stopwatch = document.getElementById("stopwatch");
const timeEl = document.getElementById("time");
const speedEl = document.getElementById("speed");
const statusEl = document.getElementById("status");

let timer=null;

role.onchange = ()=>{
  areaA.style.display = role.value==="A"?"block":"none";
  areaB.style.display = role.value==="B"?"block":"none";
};
role.onchange();

/* ===== A GENERATE ===== */
function generateCode(){
  if(!nama.value) return alert("Isi nama A");
  const code = Math.random().toString(36).substr(2,4).toUpperCase();
  ref.set({
    code,
    paired:false,
    A:nama.value,
    B:"",
    status:"IDLE",
    start_time:0,
    stop_time:0,
    distance:Number(distance.value)
  });
  kodeDiv.innerText="KODE: "+code;
}

/* ===== B PAIR ===== */
function pairB(){
  if(!nama.value||!kodeInput.value) return alert("Lengkapi data");
  ref.once("value").then(s=>{
    const d=s.val();
    if(!d) return alert("Belum ada A");
    if(d.paired) return alert("Sudah paired");
    if(kodeInput.value!==d.code) return alert("Kode salah");
    ref.update({paired:true,B:nama.value});
  });
}

/* ===== START ===== */
function start(){
  if(role.value!=="A") return;
  ref.once("value").then(s=>{
    const d=s.val();
    if(!d.paired) return alert("Belum paired");
    ref.update({status:"RUNNING",start_time:firebase.database.ServerValue.TIMESTAMP});
  });
}

/* ===== STOP ===== */
function stop(){
  if(role.value!=="B") return;
  ref.once("value").then(s=>{
    const d=s.val();
    if(d.status!=="RUNNING") return;
    ref.update({status:"STOPPED",stop_time:firebase.database.ServerValue.TIMESTAMP});
  });
}

/* ===== REALTIME ===== */
ref.on("value",s=>{
  const d=s.val();
  if(!d) return;
  statusEl.innerText="Status: "+d.status;
  stopwatch.classList.toggle("locked",!d.paired);

  if(d.status==="RUNNING"){
    clearInterval(timer);
    timer=setInterval(()=>{
      timeEl.innerText=((Date.now()-d.start_time)/1000).toFixed(3);
    },50);
  }

  if(d.status==="STOPPED"){
    clearInterval(timer);
    const dur=d.stop_time-d.start_time;
    timeEl.innerText=(dur/1000).toFixed(3);
    speedEl.innerText=((d.distance/1000)/(dur/3600000)).toFixed(2)+" km/jam";
  }
});
</script>
</body>
</html>
